<!DOCTYPE html>
<html lang="en">
<head>
  <title>Converting to --upstream-vcs-tag</title>
  <meta charset="utf-8" />
  <link href="http://blog.mycre.ws/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Robert Edmonds' blog" />
  <style>
    body {
      width: 40em;
      display: block;
    }
    code {
      background-color: lightgray;
    }
    code.boxed {
      font-size: 80%;
      display: block;
      border: 0.1em dashed;
    }
  </style>
</head>

<body>
<section itemscope itemtype="http://schema.org/Article">
  <header>
    <h2 itemprop="name">Converting to --upstream-vcs-tag</h2>
    <p>
      <strong>
        <div itemprop="description">How to convert an existing Debian packaging repository to use --upstream-vcs-tag.</div>
      </strong>
    </p>
  </header>

  <div itemprop="articleBody">
<p>Recently, the Google protobuf developers <a href="https://groups.google.com/d/msg/protobuf/3qvNnYo8-SM/GSMYGGBNXfoJ">announced</a> a migration of their
project's source code from an <a href="https://code.google.com/p/protobuf/source/browse/">svn repository</a> to a <a href="https://github.com/google/protobuf">git repository</a>. Up until
this point, the <a href="http://anonscm.debian.org/cgit/collab-maint/protobuf.git">Debian protobuf package repository</a> had only tracked upstream
development by embedding upstream release tarballs using <code>gbp import-orig</code> with
<code>pristine-tar</code>. It would be nice to smoothly migrate the packaging repository to
additionally make use of the <code>--upstream-vcs-tag</code> option to <code>gbp import-orig</code>,
the advantages of which have been <a href="http://www.eyrie.org/~eagle/journal/2013-04/001.html">well described by Russ Allbery</a>.</p>
<p>This turned out to be harder than expected, so for reference I documented the
steps I took below. Note that this packaging repository uses the default <code>gbp
import-orig</code> repository layout, where upstream sources are placed on a branch
named <code>upstream</code>, and the Debian branch is named <code>master</code>.</p>
<p>Add an <code>upstream</code> remote configured to track the upstream repository's <code>master</code>
branch and tags.</p>
<pre><code class="boxed">$ git remote add --tags --track master upstream https://github.com/google/protobuf.git
</code></pre>

<p>The <code>upstream</code> remote shouldn't be confused with our <code>upstream</code> branch. Note
that git-remotes are local to the repository, so the <code>upstream</code> remote should
probably be documented in the <code>debian/README.source</code> file.</p>
<p>Fetch the upstream branch and tags.</p>
<pre><code class="boxed">$ git fetch upstream
warning: no common commits
remote: Counting objects: 5210, done.
remote: Compressing objects: 100% (861/861), done.
remote: Total 5210 (delta 3869), reused 5194 (delta 3855)
Receiving objects: 100% (5210/5210), 3.57 MiB | 1.43 MiB/s, done.
Resolving deltas: 100% (3869/3869), done.
From https://github.com/google/protobuf
 * [new branch]      master     -&gt; upstream/master
 * [new tag]         v2.6.0     -&gt; v2.6.0
$
</code></pre>

<p>We now have a git-remote <code>upstream</code>, a remote-tracking branch <code>upstream/master</code>
which corresponds to the <code>master</code> branch that upstream makes releases from, and
a release tag <code>v2.6.0</code>. Note that the remote-tracking branch <code>upstream/master</code>
shouldn't be confused with our <code>master</code> branch.</p>
<p>Up until this point, our <code>upstream</code> branch has been synthetically generated by
importing upstream's release tarballs with <code>gbp import-orig</code>. We need to merge
this synthetic history with <code>upstream/master</code>. Unfortunately, I couldn't find a
way to do this without using a temporary branch.</p>
<pre><code class="boxed">$ git checkout -b tmp upstream/master
Branch tmp set up to track remote branch master from upstream.
Switched to a new branch 'tmp'
$ git merge -s ours -m \
  &quot;Merge the original 'upstream' branch with upstream's new master branch&quot; upstream
Merge made by the 'ours' strategy.
$ git checkout upstream
Switched to branch 'upstream'
Your branch is up-to-date with 'origin/upstream'.
$ git merge --ff-only tmp
Updating 7ed940b..9ba221e
Fast-forward
 CHANGES.txt                                                     |    49 +-
 COPYING.txt =&gt; LICENSE                                          |     0
 Makefile.am                                                     |    64 +-
 Makefile.in                                                     |  1041 --
 README.txt =&gt; README.md                                         |    49 +-
[...many more lines...]
$ git branch -D tmp
Deleted branch tmp (was 5f18f02).
$
</code></pre>

<p>There are now an additional 400 or so commits on our <code>upstream</code> branch,
corresponding to the new git repository history published by upstream.</p>
<p>Import the 2.6.0 release tarball against the upstream <code>v2.6.0</code> tag, using the
<code>--upstream-vcs-tag</code> option.</p>
<pre><code class="boxed">$ git checkout master
Switched to branch 'master'
Your branch is up-to-date with 'origin/master'.
$ gbp import-orig -u 2.6.0 --upstream-vcs-tag=v2.6.0 ~/debian/tarballs/protobuf_2.6.0.orig.tar.gz
gbp:info: Importing '/home/edmonds/debian/tarballs/protobuf_2.6.0.orig.tar.gz' to branch 'upstream'...
gbp:info: Source package is protobuf
gbp:info: Upstream version is 2.6.0
pristine-tar: committed protobuf_2.6.0.orig.tar.gz.delta to branch pristine-tar
gbp:info: Merging to 'master'
gbp:info: Successfully imported version 2.6.0 of /home/edmonds/debian/tarballs/protobuf_2.6.0.orig.tar.gz
$
</code></pre>

<p>The <code>upstream</code> branch now contains a mixture of the original series of release
tarball content imported by plain <code>gbp import-orig</code> and the <code>upstream/master</code>
branch as published by upstream.</p>
<p>Updating the Debian packaging repository when new upstream releases occur only
requires a <code>git fetch</code> to pull down upstream's updated git history and release
tag and using the <code>--upstream-vcs-tag</code> option when importing the release
tarball with <code>gbp import-orig</code>.</p>
  </div>

  <div>
    <i>
      Written by 
      <span itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Robert Edmonds</span>
        &lt;<a href="mailto:edmonds@mycre.ws" itemprop="email">edmonds@mycre.ws</a>&gt;
      </span>
      on
      <time datetime="2015-03-01T22:36:32+00:00" itemprop="datePublished">2015-03-01</time>.
    </i>
  </div>
</section>
</body>
</html>